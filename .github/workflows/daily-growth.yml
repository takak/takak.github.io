name: Daily Nature Growth

on:
  schedule:
    # JST 03:00 = UTC 18:00 (å‰æ—¥)
    - cron: '0 18 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write

jobs:
  generate-daily-scene:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./docs/ai-generated-www-nature

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd scripts
          npm install

      - name: Calculate season
        id: season
        run: |
          cd scripts
          node calculate-season.js >> $GITHUB_OUTPUT

      - name: Check if exists
        id: check
        run: |
          if [ -d "days/${{ steps.season.outputs.date_string }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Get previous scene
        if: steps.check.outputs.exists == 'false'
        id: previous
        run: |
          LATEST=$(ls -d days/*/ 2>/dev/null | sort -r | head -n 1 | sed 's:/$::')
          if [ -z "$LATEST" ]; then
            echo "is_first=true" >> $GITHUB_OUTPUT
          else
            echo "is_first=false" >> $GITHUB_OUTPUT
            cp "$LATEST/scene.json" previous-scene.json
          fi

      - name: Create initial scene
        if: steps.check.outputs.exists == 'false' && steps.previous.outputs.is_first == 'true'
        run: cp scripts/initial-scene.json previous-scene.json

      - name: Generate scene with Claude Code
        if: steps.check.outputs.exists == 'false'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          claude_args: |
            --dangerously-skip-permissions
            --model claude-opus-4-5-20251101
          # --max-turns 30
          # --debug
          prompt: |
            ã‚ãªãŸã¯ã€Œæ°¸ç¶šçš„ã«æˆé•·ã™ã‚‹è‡ªç„¶ã€ã‚’ç”Ÿæˆã™ã‚‹AIã§ã™ã€‚

            ## è§£åƒåº¦è¨­å®š
            - **4pxãƒ”ã‚¯ã‚»ãƒ«ã€200Ã—150ã‚°ãƒªãƒƒãƒ‰**ã®é«˜ç²¾ç´°ãƒ‰ãƒƒãƒˆçµµ
            - Xåº§æ¨™: 0-200
            - Yåº§æ¨™: 0-150
            - åœ°é¢ã®Yåº§æ¨™: 95

            ## ç¾åœ¨ã®çŠ¶æ…‹
            - **Total Day**: ${{ steps.season.outputs.total_day }}
            - **Cycle Year**: ${{ steps.season.outputs.cycle_year }}
            - **Day in Cycle**: ${{ steps.season.outputs.day_in_cycle }}
            - **Season**: ${{ steps.season.outputs.season_name }} (${{ steps.season.outputs.season_name_en }})
            - **Phase**: ${{ steps.season.outputs.season_phase }}
            - **Month**: ${{ steps.season.outputs.current_month }}æœˆ
            - **Is New Year**: ${{ steps.season.outputs.is_new_year }}

            ## å‰æ—¥ã®ã‚·ãƒ¼ãƒ³
            previous-scene.json ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚

            ## ã‚¿ã‚¹ã‚¯: 1æ—¥åˆ†ã®æˆé•·ã‚’ç”Ÿæˆ

            ### 1. é•·æœŸçš„æˆé•·ï¼ˆå¹´å˜ä½ï¼‰

            **Is New Year ãŒ true ã®å ´åˆï¼ˆæ–°å¹´ã®å‡¦ç†ï¼‰:**

            #### æ—¢å­˜ã®æœ¨ã®æˆé•·
            - ã™ã¹ã¦ã®æœ¨ã®å¹¹ã¨è‘‰ãŒ1å¹´åˆ†æˆé•·
            - è¨ˆç®—å¼:
              - actualHeight = baseTrunkHeight + (trunkGrowthRate Ã— (cycleYear - yearPlanted))
              - actualLeafRadius = baseLeafRadius + (leafRadiusGrowthRate Ã— (cycleYear - yearPlanted))

            #### æ–°ã—ã„è¦ç´ ã®è¿½åŠ 
            - **æ–°ã—ã„è‹—æœ¨**: Year 2ä»¥é™ã¯2-3å¹´ã«1æœ¬ã€ãã‚Œä»¥å‰ã¯ç¨€ã«1æœ¬
            - **ä½æœ¨**: Year 3ä»¥é™ã§è¿½åŠ å¯èƒ½
            - **é³¥ã®å·£**: Year 4ä»¥é™ã§é«˜ã„æœ¨ã«è¿½åŠ å¯èƒ½
            - **ã‚­ãƒã‚³**: Year 4ä»¥é™ã§ã‚³ãƒ­ãƒ‹ãƒ¼æ‹¡å¤§
            - **å€’æœ¨**: Year 8ä»¥é™ã§å¤ã„æœ¨ãŒç¨€ã«å€’ã‚Œã‚‹å¯èƒ½æ€§

            #### è‹”ãƒ»åœŸå£Œã®æˆé•·
            - å²©ã®è‹”: +0.1 (æœ€å¤§1.0)
            - å¤ã„æœ¨(æ¨¹é½¢5å¹´ä»¥ä¸Š)ã«è‹”ãŒç”Ÿãˆã‚‹
            - åœŸå£Œã®è‚¥æ²ƒåº¦: +0.05

            **Is New Year ãŒ false ã®å ´åˆï¼ˆé€šå¸¸ã®æ—¥ï¼‰:**
            - é•·æœŸçš„æˆé•·è¦ç´ ã¯å¤‰æ›´ã—ãªã„
            - å­£ç¯€ã«å¿œã˜ãŸå¤‰åŒ–ã®ã¿é©ç”¨

            ### 2. å­£ç¯€ã‚µã‚¤ã‚¯ãƒ«ï¼ˆ365æ—¥ï¼‰

            #### å†¬ (12æœˆã€œ2æœˆ) ã®å¤‰åŒ–
            - è‘‰: ã»ã¼ç„¡ã— (radius Ã— 0.1, density 0.1)
            - è‰: çŸ­ãæ¯ã‚Œè‰² (height Ã— 0.3-0.5)
            - èŠ±: ç„¡ã—
            - ã‚­ãƒã‚³: ç„¡ã—
            - å‹•ç‰©: é³¥ã®ã¿ï¼ˆå°‘æ•°ï¼‰

            #### æ˜¥ (3æœˆã€œ5æœˆ) ã®å¤‰åŒ–
            - åºç›¤(3æœˆ): æ–°èŠ½ãŒå‡ºã‚‹ã€è‰ãŒä¼¸ã³å§‹ã‚ã‚‹
            - ä¸­ç›¤(4æœˆ): èŠ±ãŒå’²ãå§‹ã‚ã‚‹ã€æœ¨ã®è‘‰ãŒå¢—ãˆã‚‹
            - çµ‚ç›¤(5æœˆ): æº€é–‹ã€è‰ãŒèŒ‚ã‚‹
            - è‘‰: radius Ã— 0.7-1.0, è–„ç·‘ â†’ ç·‘
            - è‰: height Ã— 0.6-1.0, 1-2æœ¬/æ—¥è¿½åŠ 
            - èŠ±: 2-3è¼ª/æ—¥è¿½åŠ 
            - è¶: å‡ºç¾

            #### å¤ (6æœˆã€œ8æœˆ) ã®å¤‰åŒ–
            - æœ€ã‚‚æˆé•·ãŒæ´»ç™º
            - è‘‰: ãƒ•ãƒ«ã‚µã‚¤ã‚º (radius Ã— 1.0)ã€æ¿ƒã„ç·‘
            - è‰: æœ€å¤§ã®é«˜ã•
            - èŠ±: æº€é–‹
            - å‹•ç‰©: é³¥ãƒ»è¶ãŒæœ€ã‚‚æ´»ç™º

            #### ç§‹ (9æœˆã€œ11æœˆ) ã®å¤‰åŒ–
            - åºç›¤(9æœˆ): è‰²ã¥ãå§‹ã‚ã‚‹
            - ä¸­ç›¤(10æœˆ): ç´…è‘‰ãƒ”ãƒ¼ã‚¯ã€ã‚­ãƒã‚³å‡ºç¾
            - çµ‚ç›¤(11æœˆ): è½è‘‰ã€èŠ±ãŒæ¯ã‚Œã‚‹
            - è‘‰: radius Ã— 0.8-0.5, é»„è‰² â†’ èµ¤
            - è‰: height Ã— 0.8-0.6
            - èŠ±: å¾ã€…ã«æ¸›ã‚‹
            - ã‚­ãƒã‚³: å‡ºç¾ï¼ˆYear 4ä»¥é™ï¼‰

            ## ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆå¿…é ˆï¼‰

            ```json
            {
              "metadata": {
                "resolution": "medium",
                "pixelSize": 4,
                "gridWidth": 200,
                "gridHeight": 150,
                "baseY": 95,
                "dayNumber": <total_day>,
                "cycleYear": <cycle_year>,
                "dayInCycle": <day_in_cycle>,
                "season": "<season_ja>",
                "seasonEn": "<season_en>"
              },
              "permanentElements": {
                "trees": [...],
                "rocks": [...],
                "shrubs": [...],
                "fallenTrees": [...],
                "grassPatches": [...],
                "fungiColonies": [...],
                "nests": [...]
              },
              "seasonalElements": {
                "leaves": [...],
                "grasses": [...],
                "flowers": [...],
                "mushrooms": [...],
                "animals": [...]
              },
              "ecosystem": {
                "maturityLevel": ...,
                "biodiversityScore": ...,
                "soilQuality": ...,
                "moistureLevel": ...,
                "canopyCover": ...
              }
            }
            ```

            ## é‡è¦ãªåˆ¶ç´„
            1. æ€¥æ¿€ãªå¤‰åŒ–ã‚’é¿ã‘ã‚‹ï¼ˆ1æ—¥ã‚ãŸã‚Šã®å¤‰åŒ–ã¯å°ã•ãï¼‰
            2. åº§æ¨™ã¯0-200, 0-150ã®ç¯„å›²å†…
            3. è¦ç´ ã®é‡ãªã‚Šã‚’é¿ã‘ã‚‹ï¼ˆ3-5px spacingï¼‰
            4. JSONã®ã¿å‡ºåŠ›ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã‚„èª¬æ˜æ–‡ã¯ä¸è¦ï¼‰
            5. å‡ºåŠ›ã¯ valid JSON ã®ã¿

            ## å®Ÿè¡Œæ‰‹é †
            1. previous-scene.json ã‚’èª­ã¿è¾¼ã‚€
            2. ä¸Šè¨˜ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã‚’ç”Ÿæˆ
            3. generated-scene.json ã«æ›¸ãå‡ºã™
            4. mkdir -p "days/${{ steps.season.outputs.date_string }}"
            5. mv generated-scene.json "days/${{ steps.season.outputs.date_string }}/scene.json"
            6. cd scripts && node create-day-page.js "${{ steps.season.outputs.date_string }}"
            7. cd scripts && node update-index.js

      - name: Commit
        if: steps.check.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ğŸŒ± Day ${{ steps.season.outputs.total_day }}: ${{ steps.season.outputs.season_emoji }} ${{ steps.season.outputs.season_name }}" || echo "No changes to commit"
          git push
